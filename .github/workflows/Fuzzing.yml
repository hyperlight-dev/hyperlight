name: Fuzzing Workflow

on:
  schedule:
    - cron: '0 0 * * 0' # Runs at 00:00 every Sunday
  workflow_dispatch: # Allow manual triggering

permissions:
  id-token: write
  contents: read
  
jobs:
  fuzzing:
    uses: ./.github/workflows/dep_fuzzing.yml
    with:
      targets: '["fuzz_host_print", "fuzz_guest_call", "fuzz_host_call", "fuzz_guest_trace"]' # Pass as a JSON array
      max_total_time: 18000 # 5 hours in seconds
    secrets: inherit

  notify-failure:
    runs-on: ubuntu-latest
    needs: fuzzing
    if: always() && needs.fuzzing.result == 'failure'
    permissions:
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Notify Fuzzing Failure
        run: ./dev/notify-ci-failure.sh --labels="area/fuzzing,area/testing,lifecycle/needs-review,release-blocker"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
