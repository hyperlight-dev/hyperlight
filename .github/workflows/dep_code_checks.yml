# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Code Checks

on:
  workflow_call:
    inputs:
      docs_only:
        description: Skip building if docs only
        required: false
        type: string
        default: "false"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  linux-checks:
    if: ${{ inputs.docs_only == 'false' }}
    timeout-minutes: 30
    runs-on: ["self-hosted", "Linux", "X64", "1ES.Pool=hld-kvm-amd"]
    steps:
      - uses: actions/checkout@v6

      - uses: hyperlight-dev/ci-setup-workflow@v1.8.0
        with:
          rust-toolchain: "1.89" 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fix cargo home permissions
        run: |
          sudo chown -R $(id -u):$(id -g) /opt/cargo || true

      # cargo-hyperlight builds a custom sysroot for x86_64-hyperlight-none target.
      # rust-cache cleans "anything not a dependency" from target dirs, removing the sysroot.
      # We cache sysroot separately to avoid rebuilding it (~10s) on every run.
      - name: Sysroot cache
        uses: actions/cache@v5
        with:
          path: |
            src/tests/rust_guests/simpleguest/target/sysroot
            src/tests/rust_guests/dummyguest/target/sysroot
            src/tests/rust_guests/witguest/target/sysroot
          key: sysroot-linux-${{ hashFiles('rust-toolchain.toml') }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "code-checks-linux"
          cache-on-failure: "true"
          workspaces: |
            . -> target
            src/tests/rust_guests/simpleguest -> target
            src/tests/rust_guests/dummyguest -> target
            src/tests/rust_guests/witguest -> target

      - name: Ensure up-to-date Cargo.lock
        run: cargo fetch --locked

      - name: fmt
        run: just fmt-check

      - name: clippy exhaustive check (debug)
        run: just clippy-exhaustive debug

      - name: clippy exhaustive check (release)
        run: just clippy-exhaustive release

      - name: Verify MSRV
        run: ./dev/verify-msrv.sh hyperlight-host hyperlight-guest hyperlight-guest-bin hyperlight-common

      - name: Check 32-bit builds (Nanvix compatibility)
        run: |
          rustup target add i686-unknown-linux-gnu
          just check-i686 debug

      - name: Check cargo features compile
        run: just check

      - name: Check compilation with no default features
        run: |
          just test-compilation-no-default-features debug
          just test-compilation-no-default-features release

  windows-checks:
    if: ${{ inputs.docs_only == 'false' }}
    timeout-minutes: 30
    runs-on: ["self-hosted", "Windows", "X64", "1ES.Pool=hld-win2025-amd"]
    steps:
      - uses: actions/checkout@v6

      - uses: hyperlight-dev/ci-setup-workflow@v1.8.0
        with:
          rust-toolchain: "1.89" 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # cargo-hyperlight builds a custom sysroot for x86_64-hyperlight-none target.
      # rust-cache cleans "anything not a dependency" from target dirs, removing the sysroot.
      # We cache sysroot separately to avoid rebuilding it (~10s) on every run.
      - name: Sysroot cache
        uses: actions/cache@v5
        with:
          path: |
            src/tests/rust_guests/simpleguest/target/sysroot
            src/tests/rust_guests/dummyguest/target/sysroot
            src/tests/rust_guests/witguest/target/sysroot
          key: sysroot-windows-${{ hashFiles('rust-toolchain.toml') }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "code-checks-windows"
          cache-on-failure: "true"
          workspaces: |
            . -> target
            src/tests/rust_guests/simpleguest -> target
            src/tests/rust_guests/dummyguest -> target
            src/tests/rust_guests/witguest -> target

      - name: Ensure up-to-date Cargo.lock
        run: cargo fetch --locked

      - name: fmt
        run: just fmt-check

      - name: clippy (debug)
        run: |
          just clippy debug 
          just clippy-guests debug

      - name: clippy (release)
        run: |
          just clippy release 
          just clippy-guests release

      - name: Verify MSRV
        run: ./dev/verify-msrv.sh hyperlight-host hyperlight-guest hyperlight-guest-bin hyperlight-common

      - name: Check cargo features compile
        run: just check

      - name: Check compilation with no default features
        run: |
          just test-compilation-no-default-features debug
          just test-compilation-no-default-features release
